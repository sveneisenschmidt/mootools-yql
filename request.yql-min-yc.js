/*
---
description: Request.YQL

license: MIT-style

authors:
- Sven Eisenschmidt

requires:
    core/1.3: [Native, Class, Class.Extras]
    more/1.3: [Request.JSONP]

provides: [Request.YQL]

*/
Request.YQL=new Class({Extends:Request.JSONP,_baseUrl:"http://query.yahooapis.com/v1/public/yql",_format:"json",initialize:function(c,b,a){a=a||{};b=b||false;if(typeOf(c)!="string"){c=c.toString()}if(b&&typeOf(b)=="object"){a=b;b=false}if(false!==b&&!a.onComplete){a.onComplete=b}this.parent.apply(this,[Object.append({url:this._baseUrl,data:{q:c,format:this._format}},a)])}});Request.YQL.QueryBuilder=new Class({_params:{},_parts:{use:null,select:[],from:[],where:null,limit:null},SELECT:0,DELETE:1,UPDATE:2,_type:0,_exprBuilder:null,where:function(a){if(typeOf(a)=="string"){a=new Request.YQL.QueryBuilder.Expression.Andx(arguments)}return this.add("where",a,true)},andWhere:function(d){var a=Request.YQL.QueryBuilder.Expression.Andx;var c=this.getYQLPart("where");var b=Array.clone(arguments);if(typeOf(c)=="object"&&c.constructor==a){c.addMultiple(b)}else{Array.unshift(b,c);c=new a(b)}return this.add("where",c,false)},orWhere:function(d){var a=Request.YQL.QueryBuilder.Expression.Orx;var c=this.getYQLPart("where");var b=Array.clone(arguments);if(typeOf(c)=="object"&&c.constructor==a){c.addMultiple(b)}else{Array.unshift(b,c);c=new a(b)}return this.add("where",c,false)},limit:function(a,c){var a=a?a.toInt():null,c=c?c.toInt():null;var b=new Request.YQL.QueryBuilder.Expression.Limit([a,c]);return this.add("limit",b,false)},add:function(c,b,a){var a=a?true:false;var d=!!(this._parts[c])&&typeOf(this._parts[c])=="array";if(a&&d){this._parts[c].push(b)}else{this._parts[c]=(d)?Array.from(b):b}return this},expr:function(){if(null===this._exprBuilder){this._exprBuilder=new Request.YQL.QueryBuilder.ExpressionBuilder()}return this._exprBuilder},select:function(a){this._type=this.SELECT;if(arguments.length>1){a=Array.clone(arguments)}else{if(typeOf(a)=="string"&&a.indexOf(",")!=-1){a=a.split(",")}else{if(typeOf(a)=="string"){a=Array.from(a)}else{a=Array.from("*")}}}return this.add("select",a,false)},from:function(a){return this.add("from",a,true)},use:function(b,a){if(typeOf(b)!="string"&&typeOf(a)!="string"){return this}this.add("from",a,true);return this.add("use",new Request.YQL.QueryBuilder.Expression.Use(arguments),false)},getYQL:function(){var a;switch(this._type){case this.SELECT:a=this._getYQLForSelect();break;default:throw new Error("Only SELECT is currently supported!")}if(this._params.length<1){return a}Object.each(this._params,function(c,b){a=a.replace(new RegExp("\\?"+b,"g"),"'"+c+"'")});return a},toString:function(){return this.getYQL()},_getYQLForSelect:function(){return this._getReducedYQLQueryPart("use",{pre:"USE ",post:"; "})+this._getReducedYQLQueryPart("select",{pre:"SELECT ",separator:", "})+this._getReducedYQLQueryPart("from",{pre:" FROM ",separator:", "})+this._getReducedYQLQueryPart("where",{pre:" WHERE "})+this._getReducedYQLQueryPart("limit",{pre:" LIMIT "})}.protect(),_getReducedYQLQueryPart:function(b,a){a=a||{};var c=this.getYQLPart(b);if(!c){return""}if(c.length==0){return(!!(a.empty)?a.empty:"")}return(!!(a.pre)?a.pre:"")+((typeOf(c)=="array")?c.join(a.separator):c)+(!!(a.post)?a.post:"")}.protect(),getYQLPart:function(a){return this._parts[a]},setParameters:function(a){this._params=a||{};return this},setParameter:function(a,b){b=b||null;a=a||null;if(null===a){delete this._params[a];return}this._params[a]=b;return this}});Request.YQL.QueryBuilder.ExpressionBuilder=new Class({eq:function(a,b){return new Request.YQL.QueryBuilder.Expression.Comparision(a,ComparisionOperator.EQ,b)},neq:function(a,b){return new Request.YQL.QueryBuilder.Expression.Comparision(a,ComparisionOperator.NEQ,b)},lt:function(a,b){return new Request.YQL.QueryBuilder.Expression.Comparision(a,ComparisionOperator.LT,b)},gt:function(a,b){return new Request.YQL.QueryBuilder.Expression.Comparision(a,ComparisionOperator.GT,b)},lte:function(a,b){return new Request.YQL.QueryBuilder.Expression.Comparision(a,ComparisionOperator.LTE,b)},gte:function(a,b){return new Request.YQL.QueryBuilder.Expression.Comparision(a,ComparisionOperator.GTE,b)},andX:function(a){return new Request.YQL.QueryBuilder.Expression.Andx(arguments)},orX:function(a){return new Request.YQL.QueryBuilder.Expression.Orx(arguments)},subselect:function(b,a){return new Request.YQL.QueryBuilder.Expression.SubSelect(b,a)}});Request.YQL.QueryBuilder.Expression=new Class({_preSeparator:"(",_separator:", ",_postSeparator:")",_parts:[],initialize:function(a){a=a?a:[];this.addMultiple(a)},addMultiple:function(a){Array.each(a,this.add.bind(this))},add:function(a){if(a){this._parts.push(a)}},toString:function(){return this._preSeparator+this._parts.join(this._separator)+this._postSeparator},count:function(){return this._parts.length}});Request.YQL.QueryBuilder.Expression.Andx=new Class({Implements:[Request.YQL.QueryBuilder.Expression],_separator:") AND ("});Request.YQL.QueryBuilder.Expression.Orx=new Class({Implements:[Request.YQL.QueryBuilder.Expression],_separator:") OR ("});Request.YQL.QueryBuilder.Expression.Limit=new Class({Implements:[Request.YQL.QueryBuilder.Expression],_preSeparator:"",_separator:",",_postSeparator:""});Request.YQL.QueryBuilder.Expression.Use=new Class({Implements:[Request.YQL.QueryBuilder.Expression],_preSeparator:"",_separator:" as ",_postSeparator:"",toString:function(){return this._preSeparator+"'"+this._parts[0]+"'"+this._separator+this._parts[1]+this._postSeparator}});Request.YQL.QueryBuilder.Expression.SubSelect=new Class({Implements:[Request.YQL.QueryBuilder],_operator:"in",_field:null,initialize:function(b,a){this._field=b||this._field;this._operator=a||this._operator},toString:function(){return this._field+" "+this._operator+" ("+this.getYQL()+")"}});Request.YQL.QueryBuilder.Expression.Comparision=new Class({_leftExpr:null,_operator:null,_rightExpr:null,initialize:function(c,a,b){this._leftExpr=c;this._rightExpr=b;this._operator=a},toString:function(){return this._leftExpr+" "+this._operator+" "+this._rightExpr}});var ComparisionOperator=Request.YQL.QueryBuilder.Expression.ComparisionOperator={EQ:"=",NEQ:"<>",LT:"<",LTE:"<=",GT:">",GTE:">="};