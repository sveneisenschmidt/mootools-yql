Request.YQL=new Class({Extends:Request.JSONP,_baseUrl:"http://query.yahooapis.com/v1/public/yql",_formats:["json","xml"],initialize:function(c,a){if(typeOf(c)!="string"){c=c.toString()}a=a||{};var b=a.data||{};b.format=this._formats.contains(a.format)?a.format:"json";b.q=c;a.data=b;a.url=this._baseUrl;this.parent(a)}});(function(){Request.YQL.QueryBuilder=builder=new Class({_params:{},_parts:{use:null,select:[],from:[],where:null,limit:null},SELECT:0,DELETE:1,UPDATE:2,_type:0,_exprBuilder:null,where:function(a){if(typeOf(a)=="string"){a=new expr.Andx(arguments)}return this.add("where",a,true)},andWhere:function(d){var a=expr.Andx;var c=this.getYQLPart("where");var b=Array.clone(arguments);if(typeOf(c)=="object"&&c.constructor==a){c.addMultiple(b)}else{Array.unshift(b,c);c=new a(b)}return this.add("where",c,false)},orWhere:function(d){var a=expr.Orx;var c=this.getYQLPart("where");var b=Array.clone(arguments);if(typeOf(c)=="object"&&c.constructor==a){c.addMultiple(b)}else{Array.unshift(b,c);c=new a(b)}return this.add("where",c,false)},limit:function(a,c){var a=a?a.toInt():null,c=c?c.toInt():null;var b=new expr.Limit([a,c]);return this.add("limit",b,false)},add:function(c,b,a){var a=a?true:false;var d=!!(this._parts[c])&&typeOf(this._parts[c])=="array";if(a&&d){this._parts[c].push(b)}else{this._parts[c]=(d)?Array.from(b):b}return this},expr:function(){if(null===this._exprBuilder){this._exprBuilder=new expressionBuilder()}return this._exprBuilder},select:function(a){this._type=this.SELECT;if(arguments.length>1){a=Array.clone(arguments)}else{if(typeOf(a)=="string"&&a.indexOf(",")!=-1){a=a.split(",")}else{if(typeOf(a)=="string"){a=Array.from(a)}else{a=Array.from("*")}}}return this.add("select",a,false)},from:function(a){return this.add("from",a,true)},use:function(b,a){if(typeOf(b)!="string"&&typeOf(a)!="string"){return this}this.add("from",a,true);return this.add("use",new expr.Use(arguments),false)},getYQL:function(){var a;switch(this._type){case this.SELECT:a=this._getYQLForSelect();break;default:throw new Error("Only SELECT is currently supported!")}if(this._params.length<1){return a}Object.each(this._params,function(c,b){a=a.replace(new RegExp("\\?"+b,"g"),"'"+c+"'")});return a},toString:function(){return this.getYQL()},_getYQLForSelect:function(){return this._getReducedYQLQueryPart("use",{pre:"USE ",post:"; "})+this._getReducedYQLQueryPart("select",{pre:"SELECT ",separator:", "})+this._getReducedYQLQueryPart("from",{pre:" FROM ",separator:", "})+this._getReducedYQLQueryPart("where",{pre:" WHERE "})+this._getReducedYQLQueryPart("limit",{pre:" LIMIT "})}.protect(),_getReducedYQLQueryPart:function(b,a){a=a||{};var c=this.getYQLPart(b);if(!c){return""}if(c.length==0){return(!!(a.empty)?a.empty:"")}return(!!(a.pre)?a.pre:"")+((typeOf(c)=="array")?c.join(a.separator):c)+(!!(a.post)?a.post:"")}.protect(),getYQLPart:function(a){return this._parts[a]},setParameters:function(a){this._params=a||{};return this},setParameter:function(a,b){b=b||null;a=a||null;if(null===a){delete this._params[a];return}this._params[a]=b;return this}});builder.ExpressionBuilder=expressionBuilder=new Class({eq:function(a,b){return new comparision(a,comparisionOperator.EQ,b)},neq:function(a,b){return new comparision(a,comparisionOperator.NEQ,b)},lt:function(a,b){return new comparision(a,comparisionOperator.LT,b)},gt:function(a,b){return new comparision(a,comparisionOperator.GT,b)},lte:function(a,b){return new comparision(a,comparisionOperator.LTE,b)},gte:function(a,b){return new comparision(a,comparisionOperator.GTE,b)},andX:function(a){return new expr.Andx(arguments)},orX:function(a){return new expr.Orx(arguments)},subselect:function(b,a){return new expr.SubSelect(b,a)}});builder.Expression=expr=new Class({_preSeparator:"(",_separator:", ",_postSeparator:")",_parts:[],initialize:function(a){a=a?a:[];this.addMultiple(a)},addMultiple:function(a){Array.each(a,this.add.bind(this))},add:function(a){if(a){this._parts.push(a)}},toString:function(){return this._preSeparator+this._parts.join(this._separator)+this._postSeparator},count:function(){return this._parts.length}});expr.Andx=new Class({Implements:[expr],_separator:") AND ("});expr.Orx=new Class({Implements:[expr],_separator:") OR ("});expr.Limit=new Class({Implements:[expr],_preSeparator:"",_separator:",",_postSeparator:""});expr.Use=new Class({Implements:[expr],_preSeparator:"",_separator:" as ",_postSeparator:"",toString:function(){return this._preSeparator+"'"+this._parts[0]+"'"+this._separator+this._parts[1]+this._postSeparator}});expr.SubSelect=new Class({Implements:[builder],_operator:"in",_field:null,initialize:function(b,a){this._field=b||this._field;this._operator=a||this._operator},toString:function(){return this._field+" "+this._operator+" ("+this.getYQL()+")"}});expr.Comparision=comparision=new Class({_leftExpr:null,_operator:null,_rightExpr:null,initialize:function(c,a,b){this._leftExpr=c;this._rightExpr=b;this._operator=a},toString:function(){return this._leftExpr+" "+this._operator+" "+this._rightExpr}});expr.ComparisionOperator=comparisionOperator={EQ:"=",NEQ:"<>",LT:"<",LTE:"<=",GT:">",GTE:">="}}());